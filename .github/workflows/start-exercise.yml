name: Start Exercise

on:
  workflow_call:
    inputs:
      exercise-title:
        description: "Title of the exercise"
        required: true
        type: string
      issue-title-prefix:
        description: "Prefix for the exercise title in the issue"
        required: false
        type: string
        default: "Exercise: "
      intro-message:
        description: "Introduction message for the exercise"
        required: true
        type: string
    outputs:
      issue-url:
        description: "URL of the created issue"
        value: ${{ jobs.create_exercise.outputs.issue-url }}
      issue-number:
        description: "Number of the created issue"
        value: ${{ jobs.create_exercise.outputs.issue-number }}
    secrets:
      THEALBERTDEVBOT_APP_ID:
        required: true
      THEALBERTDEVBOT_SECRET_KEY:
        required: true

permissions:
  contents: write
  actions: write
  issues: write

env:
  EXERCISE_TOOLKIT_REF: v1

jobs:
  disable_workflows:
    name: Disable exercise workflows
    runs-on: ubuntu-latest

    steps:
      - name: Get GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with: 
          app-id: ${{ secrets.THEALBERTDEVBOT_APP_ID }}
          private-key: ${{ secrets.THEALBERTDEVBOT_SECRET_KEY }}
          owner: ${{ github.repository_owner }}
          
      - uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Disable all exercise workflows
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Find all workflow files that start with a number (0-9)
          workflows=$(git ls-files | grep -E '^\.github/workflows/[0-9].*\.(yml|yaml)$')
          for workflow in $workflows; do
            workflow_name="$(basename "$workflow")"
            echo "Disabling workflow: $workflow_name"
            gh workflow disable "$workflow_name" || true
          done

  create_exercise:
    name: Create exercise issue
    runs-on: ubuntu-latest
    needs: disable_workflows

    outputs:
      issue-url: ${{ steps.create-issue.outputs.ISSUE_URL }}
      issue-number: ${{ steps.create-issue.outputs.ISSUE_NUMBER }}

    steps:
      - name: Get GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with: 
          app-id: ${{ secrets.THEALBERTDEVBOT_APP_ID }}
          private-key: ${{ secrets.THEALBERTDEVBOT_SECRET_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get response templates
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: thealbertdev/masb-course-toolkit
          path: masb-course-toolkit
          ref: ${{ env.EXERCISE_TOOLKIT_REF }}

      - name: Get template repository
        id: get-template-repo
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            if (repo.template_repository) {
              console.log(`Template repository found: ${repo.template_repository.full_name}`);
              const issueReportUrl = `https://github.com/${repo.template_repository.full_name}/issues`;
              core.setOutput('ISSUE_REPORT_URL', issueReportUrl);
            } else {
              console.log('No template repository found for this repository');
            }

      - name: Build welcome message from template
        id: build-issue-description
        uses: skills/action-text-variables@v3
        with:
          template-file: masb-course-toolkit/markdown-templates/step-feedback/welcome.md
          template-vars: |
            title: ${{ inputs.exercise-title }}
            login: ${{ github.actor }}
            intro_message: ${{ inputs.intro-message }}
            bug_report_url: ${{ steps.get-template-repo.outputs.ISSUE_REPORT_URL || '' }}

      - name: Create issue - add welcome message
        id: create-issue
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${process.env.ISSUE_TITLE_PREFIX}${process.env.EXERCISE_TITLE}`,
              body: process.env.ISSUE_BODY
            });
            core.setOutput('ISSUE_URL', issue.html_url);
            core.setOutput('ISSUE_NUMBER', issue.number);
        env:
          ISSUE_BODY: ${{ steps.build-issue-description.outputs.updated-text }}
          EXERCISE_TITLE: ${{ inputs.exercise-title }}
          ISSUE_TITLE_PREFIX: ${{ inputs.issue-title-prefix }}

  update_readme:
    name: Update README
    runs-on: ubuntu-latest
    needs: create_exercise

    steps:
      - name: Get GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with: 
          app-id: ${{ secrets.THEALBERTDEVBOT_APP_ID }}
          private-key: ${{ secrets.THEALBERTDEVBOT_SECRET_KEY }}
          owner: ${{ github.repository_owner }}

      - uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Get response templates
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: thealbertdev/masb-course-toolkit
          path: masb-course-toolkit
          ref: ${{ env.EXERCISE_TOOLKIT_REF }}

      - name: Build welcome message from template
        id: build-new-readme
        uses: skills/action-text-variables@v3
        with:
          template-file: masb-course-toolkit/markdown-templates/readme/exercise-started.md
          template-vars: |
            title: ${{ inputs.exercise-title }}
            login: ${{ github.actor }}
            issue_url: ${{ needs.create_exercise.outputs.issue-url }}

      - name: Overwrite README
        env:
          README_TEXT: ${{ steps.build-new-readme.outputs.updated-text }}
        run: echo "$README_TEXT" > README.md

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          add: "README.md"
          message: "Start exercise"